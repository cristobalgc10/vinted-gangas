{% extends "base.html" %}

{% block title %}Productos - Vinted Scraper{% endblock %}

{% block content %}
<div>
    <!-- Cabecera -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Productos Encontrados</h1>
        <p class="mt-2 text-gray-600">Revisa los productos que coinciden con tus b√∫squedas</p>
    </div>

    <!-- Filtros y controles -->
    <div class="mb-6">
        <!-- Fila √∫nica con todos los controles -->
        <div class="flex flex-wrap justify-between items-end gap-4 mb-4">
            <!-- Filtros izquierda -->
            <div class="flex gap-4 items-end flex-wrap">
                <div>
                    <label for="search_id" class="block text-sm font-medium text-gray-700 mb-1">B√∫squeda</label>
                    <select name="search_id" id="search_id" class="px-3 py-2 border rounded-lg"
                        onchange="resetPageAndReload()">
                        <option value="">Todas</option>
                        {% for search in searches %}
                        <option value="{{ search.id }}" {% if selected_search_id==search.id %}selected{% endif %}>
                            {{ search.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Favoritos</label>
                    <button type="button" id="favorite-toggle" data-state="{{ view_mode or 'all' }}"
                        class="px-4 py-2 border rounded-lg transition-all duration-200 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onclick="toggleFavoriteFilter()">
                        {% if view_mode == 'fav' %}
                        <span class="text-2xl">‚ù§Ô∏è</span>
                        {% else %}
                        <span class="text-2xl text-gray-400">ü§ç</span>
                        {% endif %}
                    </button>
                </div>

                <div>
                    <label for="order_by" class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
                    <select name="order_by" id="order_by" class="px-3 py-2 border rounded-lg bg-white"
                        onchange="resetPageAndReload()">
                        <option value="date_desc" {% if order_by=='date_desc' %}selected{% endif %}>üìÖ M√°s recientes
                        </option>
                        <option value="date_asc" {% if order_by=='date_asc' %}selected{% endif %}>üìÖ M√°s antiguos
                        </option>
                        <option value="price_asc" {% if order_by=='price_asc' %}selected{% endif %}>üí∞ Precio: menor a
                            mayor</option>
                        <option value="price_desc" {% if order_by=='price_desc' %}selected{% endif %}>üí∞ Precio: mayor a
                            menor</option>
                    </select>
                </div>

                <div>
                    <label for="per_page" class="block text-sm font-medium text-gray-700 mb-1">Por p√°gina</label>
                    <select name="per_page" id="per_page" class="px-3 py-2 border rounded-lg bg-white"
                        onchange="resetPageAndReload()">
                        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                        <option value="75" {% if per_page==75 %}selected{% endif %}>75</option>
                        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                    </select>
                </div>

                <div id="products-indicator" class="htmx-indicator">‚è≥</div>
            </div>

            <!-- Selector de vista derecha -->
            <div class="flex gap-1 border border-gray-300 rounded-lg p-1 bg-white">
                <button type="button" id="view-grid"
                    class="p-2.5 rounded-md transition-all duration-200 view-toggle {% if current_view == 'grid' or not current_view %}bg-blue-500 text-white shadow-md{% else %}text-gray-500 hover:text-gray-700 hover:bg-gray-100{% endif %}"
                    onclick="changeView('grid')" title="Vista en cuadr√≠cula">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                </button>
                <button type="button" id="view-list"
                    class="p-2.5 rounded-md transition-all duration-200 view-toggle {% if current_view == 'list' %}bg-blue-500 text-white shadow-md{% else %}text-gray-500 hover:text-gray-700 hover:bg-gray-100{% endif %}"
                    onclick="changeView('list')" title="Vista en lista">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Fila de info de paginaci√≥n -->
        <div class="text-sm text-gray-600 text-center">
            Mostrando <span class="font-semibold">{{ ((page - 1) * per_page) + 1 }}</span> -
            <span class="font-semibold">{% if page * per_page < total_products %}{{ page * per_page }}{% else %}{{
                    total_products }}{% endif %}</span>
                    de <span class="font-semibold">{{ total_products }}</span> productos
        </div>
    </div>

    <!-- Grid de productos (usa fragmento reutilizable) -->
    <div id="products-grid" class="transition-opacity duration-200" style="opacity: 0;">
        {% if current_view == 'list' %}
        {% include "_products_list.html" %}
        {% else %}
        {% include "_products_grid.html" %}
        {% endif %}
    </div>

    <!-- Paginaci√≥n -->
    {% if total_pages > 1 %}
    <div class="mt-8 flex justify-center items-center gap-2">
        <!-- Bot√≥n Anterior -->
        <button onclick="goToPage({{ page - 1 }})" {% if page <=1 %}disabled{% endif %}
            class="px-4 py-2 border rounded-lg transition-colors {% if page <= 1 %}bg-gray-100 text-gray-400 cursor-not-allowed{% else %}bg-white hover:bg-gray-50 text-gray-700{% endif %}">
            ‚Üê Anterior
        </button>

        <!-- N√∫meros de p√°gina -->
        <div class="flex gap-1">
            {% set start_page = page - 2 if page - 2 > 1 else 1 %}
            {% set end_page = page + 2 if page + 2 < total_pages else total_pages %} {% if start_page> 1 %}
                <button onclick="goToPage(1)" class="px-3 py-2 border rounded hover:bg-gray-50">1</button>
                {% if start_page > 2 %}
                <span class="px-3 py-2">...</span>
                {% endif %}
                {% endif %}

                {% for p in range(start_page, end_page + 1) %}
                <button onclick="goToPage({{ p }})"
                    class="px-3 py-2 border rounded transition-colors {% if p == page %}bg-blue-500 text-white font-semibold{% else %}hover:bg-gray-50{% endif %}">
                    {{ p }}
                </button>
                {% endfor %}

                {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <span class="px-3 py-2">...</span>
                    {% endif %}
                    <button onclick="goToPage({{ total_pages }})" class="px-3 py-2 border rounded hover:bg-gray-50">{{
                        total_pages }}</button>
                    {% endif %}
        </div>

        <!-- Bot√≥n Siguiente -->
        <button onclick="goToPage({{ page + 1 }})" {% if page>= total_pages %}disabled{% endif %}
            class="px-4 py-2 border rounded-lg transition-colors {% if page >= total_pages %}bg-gray-100 text-gray-400
            cursor-not-allowed{% else %}bg-white hover:bg-gray-50 text-gray-700{% endif %}">
            Siguiente ‚Üí
        </button>
    </div>
    {% endif %}
</div>

<script>
    // ============================================================================
    // ESTADO GLOBAL
    // ============================================================================
    let currentView = localStorage.getItem('productsView');
    let currentPage = {{ page }};
    const serverView = '{{ current_view|default("grid") }}';

    // Si no hay localStorage, usar vista del servidor
    if (!currentView) {
        currentView = serverView;
        localStorage.setItem('productsView', currentView);
    }

    // ============================================================================
    // INICIALIZACI√ìN
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function () {
        const productsGrid = document.getElementById('products-grid');

        console.log('üîß Inicializando...');
        console.log('üì¶ Vista en localStorage:', currentView);
        console.log('üñ•Ô∏è Vista del servidor:', serverView);

        updateViewButtons();

        // Si la vista guardada es diferente a la del servidor, cargar la correcta
        if (currentView !== serverView) {
            console.log('‚ö†Ô∏è Vistas desincronizadas - recargando con vista correcta');
            // Mantener oculto mientras carga la vista correcta
            reloadProducts().then(() => {
                // Mostrar con fade-in despu√©s de cargar
                setTimeout(() => {
                    productsGrid.style.opacity = '1';
                    console.log('‚úÖ Vista correcta mostrada');
                }, 50);
            });
        } else {
            // Las vistas coinciden - mostrar inmediatamente
            console.log('‚úÖ Vista correcta desde el servidor - mostrando inmediatamente');
            productsGrid.style.opacity = '1';
        }
    });

    // ============================================================================
    // FUNCIONES DE VISTA (GRID/LIST)
    // ============================================================================
    function changeView(view) {
        if (view === currentView) {
            return; // Ya estamos en esa vista
        }

        currentView = view;
        localStorage.setItem('productsView', view);
        updateViewButtons();
        reloadProducts();
    }

    function updateViewButtons() {
        const gridBtn = document.getElementById('view-grid');
        const listBtn = document.getElementById('view-list');

        if (!gridBtn || !listBtn) return;

        [gridBtn, listBtn].forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white', 'shadow-md', 'text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
        });

        if (currentView === 'grid') {
            gridBtn.classList.add('bg-blue-500', 'text-white', 'shadow-md');
            listBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
        } else {
            listBtn.classList.add('bg-blue-500', 'text-white', 'shadow-md');
            gridBtn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-100');
        }
    }

    // ============================================================================
    // FUNCIONES DE PAGINACI√ìN
    // ============================================================================
    function goToPage(page) {
        currentPage = page;
        reloadProducts(true); // true = hacer scroll al inicio
    }

    function resetPageAndReload() {
        currentPage = 1;
        reloadProducts();
    }

    // ============================================================================
    // FUNCI√ìN PRINCIPAL DE RECARGA
    // ============================================================================
    function reloadProducts(scrollTop = false) {
        const searchSelect = document.getElementById('search_id');
        const favoriteToggle = document.getElementById('favorite-toggle');
        const orderBy = document.getElementById('order_by');
        const perPage = document.getElementById('per_page');

        const searchId = searchSelect ? searchSelect.value : '';
        const favoriteState = favoriteToggle ? favoriteToggle.getAttribute('data-state') || 'all' : 'all';
        const orderByValue = orderBy ? orderBy.value : 'date_desc';
        const perPageValue = perPage ? perPage.value : '25';

        // Construir URL con todos los par√°metros
        let url = '/products?favorite_filter=' + favoriteState +
            '&view=' + currentView +
            '&page=' + currentPage +
            '&per_page=' + perPageValue +
            '&order_by=' + orderByValue;

        if (searchId) {
            url += '&search_id=' + searchId;
        }

        console.log('üîÑ Recargando productos con URL:', url);
        console.log('üìç Vista actual:', currentView);

        // Mostrar indicador
        const indicator = document.getElementById('products-indicator');
        if (indicator) indicator.classList.add('htmx-request');

        const productsGrid = document.getElementById('products-grid');

        // Fade out
        if (productsGrid) productsGrid.style.opacity = '0';

        // Hacer la petici√≥n
        fetch(url)
            .then(response => response.text())
            .then(html => {
                // Parsear el HTML completo
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Extraer el grid de productos (con la vista correcta)
                const newProductsGrid = doc.querySelector('#products-grid');
                const currentProductsGrid = document.getElementById('products-grid');

                if (newProductsGrid && currentProductsGrid) {
                    // Reemplazar el contenido del grid
                    currentProductsGrid.innerHTML = newProductsGrid.innerHTML;
                    console.log('‚úÖ Grid actualizado');
                }

                // Actualizar los controles de paginaci√≥n si existen
                const newPagination = doc.querySelector('.mt-8.flex.justify-center');
                const currentPagination = document.querySelector('.mt-8.flex.justify-center');

                if (newPagination && currentPagination) {
                    currentPagination.innerHTML = newPagination.innerHTML;
                    console.log('‚úÖ Paginaci√≥n actualizada');
                } else if (newPagination && !currentPagination) {
                    // A√±adir paginaci√≥n si no exist√≠a
                    const productsContainer = document.getElementById('products-grid').parentElement;
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'mt-8 flex justify-center items-center gap-2';
                    paginationDiv.innerHTML = newPagination.innerHTML;
                    productsContainer.appendChild(paginationDiv);
                    console.log('‚úÖ Paginaci√≥n a√±adida');
                } else if (!newPagination && currentPagination) {
                    // Eliminar paginaci√≥n si ya no es necesaria
                    currentPagination.remove();
                    console.log('‚úÖ Paginaci√≥n eliminada');
                }

                // Actualizar la info de paginaci√≥n (Mostrando X-Y de Z)
                const newInfo = doc.querySelector('.text-sm.text-gray-600.text-center');
                const currentInfo = document.querySelector('.text-sm.text-gray-600.text-center');

                if (newInfo && currentInfo) {
                    currentInfo.innerHTML = newInfo.innerHTML;
                    console.log('‚úÖ Info de paginaci√≥n actualizada');
                }

                // Procesar HTMX en el nuevo contenido
                if (currentProductsGrid) {
                    htmx.process(currentProductsGrid);
                }

                // Actualizar botones de vista
                updateViewButtons();

                // Fade in
                setTimeout(() => {
                    if (productsGrid) productsGrid.style.opacity = '1';
                }, 50);

                // Scroll si es necesario
                if (scrollTop) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            })
            .catch(error => {
                console.error('‚ùå Error recargando productos:', error);
                if (productsGrid) productsGrid.style.opacity = '1';
            })
            .finally(() => {
                if (indicator) indicator.classList.remove('htmx-request');
            });

        return Promise.resolve();
    }

    // ============================================================================
    // FILTRO DE FAVORITOS
    // ============================================================================
    function toggleFavoriteFilter() {
        const toggleBtn = document.getElementById('favorite-toggle');
        let currentState = toggleBtn.getAttribute('data-state') || 'all';

        let newState = currentState === 'all' ? 'fav' : 'all';
        toggleBtn.setAttribute('data-state', newState);

        if (newState === 'fav') {
            toggleBtn.innerHTML = '<span class="text-2xl">‚ù§Ô∏è</span>';
            toggleBtn.classList.add('bg-red-50', 'border-red-300');
            toggleBtn.classList.remove('bg-white');
        } else {
            toggleBtn.innerHTML = '<span class="text-2xl text-gray-400">ü§ç</span>';
            toggleBtn.classList.remove('bg-red-50', 'border-red-300');
            toggleBtn.classList.add('bg-white');
        }

        resetPageAndReload();
    }
</script>
{% endblock %}