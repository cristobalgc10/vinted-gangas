{% extends "base.html" %}

{% block title %}Dashboard - Vinted Scraper{% endblock %}

{% block content %}
<div>
    <!-- T√≠tulo de la p√°gina -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="mt-2 text-gray-600">Resumen de tu actividad de scraping</p>
        </div>
        <div class="flex space-x-3">
            <a href="/scheduler" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <span>üìÖ</span>
                <span>Scheduler</span>
            </a>
            <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <span>üîÑ</span>
                <span>Actualizar</span>
            </button>
        </div>
    </div>

    <!-- Tarjetas de estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total de b√∫squedas -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-3xl">üîç</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">B√∫squedas totales</p>
                    <p class="text-2xl font-bold text-gray-900">{{ stats.total_searches }}</p>
                </div>
            </div>
        </div>

        <!-- B√∫squedas activas -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-3xl">‚úÖ</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">B√∫squedas activas</p>
                    <p class="text-2xl font-bold text-green-600">{{ stats.active_searches }}</p>
                </div>
            </div>
        </div>

        <!-- Total de productos -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-3xl">üì¶</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Productos encontrados</p>
                    <p class="text-2xl font-bold text-gray-900">{{ stats.total_products }}</p>
                </div>
            </div>
        </div>

        <!-- Productos nuevos -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span class="text-3xl">üÜï</span>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Productos nuevos</p>
                    <p class="text-2xl font-bold text-blue-600">{{ stats.new_products }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚≠ê NUEVO: Gr√°fico de productos por d√≠a (√∫ltimos 7 d√≠as) -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä Productos encontrados (√∫ltimos 7 d√≠as)</h2>
        <canvas id="productsChart" width="800" height="200"></canvas>
    </div>

    <!-- Grid de dos columnas para b√∫squedas y productos recientes -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- B√∫squedas recientes -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">B√∫squedas recientes</h2>
                    <a href="/searches" class="text-sm text-blue-500 hover:text-blue-600">Ver todas ‚Üí</a>
                </div>
            </div>
            <div class="p-6">
                {% if searches %}
                <div class="space-y-4">
                    {% for search in searches %}
                    <div class="border-l-4 {% if search.is_active %}border-green-500{% else %}border-gray-300{% endif %} pl-4 py-2">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">{{ search.name }}</h3>
                                {% if search.query %}
                                <p class="text-sm text-gray-600 mt-1">{{ search.query }}</p>
                                {% endif %}
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                    {% if search.price_from or search.price_to %}
                                    <span>üí∞
                                        {% if search.price_from %}{{ search.price_from }}‚Ç¨{% else %}0‚Ç¨{% endif %} -
                                        {% if search.price_to %}{{ search.price_to }}‚Ç¨{% else %}‚àû{% endif %}
                                    </span>
                                    {% endif %}
                                    <span>‚è±Ô∏è Cada {{ search.interval_minutes }} min</span>
                                    <span>{% if search.is_active %}üü¢ Activa{% else %}‚ö´ Pausada{% endif %}</span>
                                    {% if search.last_run_at %}
                                    <span>üïí {{ search.last_run_at.strftime('%d/%m %H:%M') }}</span>
                                    {% endif %}
                                    <span>üì¶ {{ search.products_count or 0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p class="text-xl mb-2">üì≠</p>
                    <p>No hay b√∫squedas todav√≠a</p>
                    <button onclick="openModal('/searches/new?modal=1')" class="text-blue-500 hover:text-blue-600 text-sm mt-2 inline-block">
                        Crear tu primera b√∫squeda
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Productos recientes -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Productos recientes</h2>
                    <a href="/products" class="text-sm text-blue-500 hover:text-blue-600">Ver todos ‚Üí</a>
                </div>
            </div>
            <div class="p-6">
                {% if products %}
                <div class="space-y-4">
                    {% for product in products[:5] %}
                    <div class="flex space-x-4 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                        <!-- Imagen del producto -->
                        <div class="flex-shrink-0">
                            {% if product.image_url %}
                            <img src="{{ product.image_url }}" alt="{{ product.title }}"
                                class="w-16 h-16 rounded object-cover">
                            {% else %}
                            <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
                                <span class="text-2xl">üëï</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Info del producto -->
                        <div class="flex-1 min-w-0">
                            <a href="{{ product.url }}" target="_blank"
                                class="font-medium text-gray-900 hover:text-blue-600 line-clamp-2">
                                {{ product.title }}
                            </a>
                            <div class="flex items-center space-x-3 mt-1">
                                <span class="text-lg font-bold text-green-600">{{ product.price }}‚Ç¨</span>
                                {% if product.seller_country %}
                                <span class="text-xs text-gray-500">üìç {{ product.seller_country }}</span>
                                {% endif %}
                                {% if not product.is_notified %}
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Nuevo</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p class="text-xl mb-2">üì¶</p>
                    <p>No hay productos encontrados todav√≠a</p>
                    <p class="text-sm mt-2">Los productos aparecer√°n cuando ejecutes tus b√∫squedas</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Secci√≥n de acciones r√°pidas -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üöÄ Acciones r√°pidas</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <button onclick="openModal('/searches/new?modal=1')"
                class="block p-4 bg-white rounded-lg hover:shadow-md transition-shadow text-left">
                <div class="text-2xl mb-2">‚ûï</div>
                <h4 class="font-semibold text-gray-900">Crear b√∫squeda</h4>
                <p class="text-sm text-gray-600 mt-1">Define qu√© productos quieres encontrar</p>
            </button>

            <a href="/scheduler" class="block p-4 bg-white rounded-lg hover:shadow-md transition-shadow">
                <div class="text-2xl mb-2">üìÖ</div>
                <h4 class="font-semibold text-gray-900">Ver Scheduler</h4>
                <p class="text-sm text-gray-600 mt-1">Monitorea las b√∫squedas autom√°ticas</p>
            </a>

            <a href="/docs" target="_blank" class="block p-4 bg-white rounded-lg hover:shadow-md transition-shadow">
                <div class="text-2xl mb-2">üìö</div>
                <h4 class="font-semibold text-gray-900">Ver API</h4>
                <p class="text-sm text-gray-600 mt-1">Documentaci√≥n completa de la API</p>
            </a>

            <a href="/settings" class="block p-4 bg-white rounded-lg hover:shadow-md transition-shadow">
                <div class="text-2xl mb-2">‚öôÔ∏è</div>
                <h4 class="font-semibold text-gray-900">Configuraci√≥n</h4>
                <p class="text-sm text-gray-600 mt-1">Ajusta notificaciones y filtros</p>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ‚≠ê GR√ÅFICO DE PRODUCTOS POR D√çA (usando Canvas API nativa, sin Chart.js)
async function loadProductsChart() {
    try {
        // Obtener datos del servidor
        const response = await fetch('/api/stats/detailed');
        const data = await response.json();
        
        if (!data.products_by_day || data.products_by_day.length === 0) {
            return;
        }
        
        const canvas = document.getElementById('productsChart');
        const ctx = canvas.getContext('2d');
        
        // Dimensiones
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;
        
        // Datos
        const labels = data.products_by_day.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
        });
        const values = data.products_by_day.map(d => d.count);
        const maxValue = Math.max(...values, 1);
        
        // Limpiar canvas
        ctx.clearRect(0, 0, width, height);
        
        // Fondo blanco
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);
        
        // Grid y ejes
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        
        // L√≠neas horizontales del grid
        const gridLines = 5;
        for (let i = 0; i <= gridLines; i++) {
            const y = padding + (chartHeight / gridLines) * i;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
            
            // Etiquetas del eje Y
            const value = Math.round(maxValue * (1 - i / gridLines));
            ctx.fillStyle = '#6b7280';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(value.toString(), padding - 10, y + 4);
        }
        
        // Calcular posiciones de las barras
        const barWidth = chartWidth / values.length * 0.6;
        const barSpacing = chartWidth / values.length;
        
        // Dibujar barras
        values.forEach((value, index) => {
            const barHeight = (value / maxValue) * chartHeight;
            const x = padding + barSpacing * index + (barSpacing - barWidth) / 2;
            const y = height - padding - barHeight;
            
            // Gradiente para las barras
            const gradient = ctx.createLinearGradient(x, y, x, height - padding);
            gradient.addColorStop(0, '#3b82f6');
            gradient.addColorStop(1, '#60a5fa');
            
            // Dibujar barra
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Borde de la barra
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, barWidth, barHeight);
            
            // Valor encima de la barra
            if (value > 0) {
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(value.toString(), x + barWidth / 2, y - 5);
            }
            
            // Etiqueta del eje X
            ctx.fillStyle = '#6b7280';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(labels[index], x + barWidth / 2, height - padding + 20);
        });
        
        // T√≠tulo del eje Y
        ctx.save();
        ctx.fillStyle = '#374151';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('Productos', 0, 0);
        ctx.restore();
        
    } catch (error) {
        console.error('Error cargando gr√°fico:', error);
    }
}

// Cargar gr√°fico cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', loadProductsChart);
</script>
{% endblock %}
